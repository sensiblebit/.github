name: PR Conventions

on:
  workflow_call:
    inputs:
      types:
        description: "Newline-separated list of valid Conventional Commit types"
        required: false
        type: string
        default: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
      exempt_branch_prefixes:
        description: "Newline-separated list of exempt branch prefixes (e.g. dependabot, release)"
        required: false
        type: string
        default: |
          dependabot/
          release/

jobs:
  pr-title:
    name: PR Title
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: ${{ inputs.types }}

  pr-conventions:
    name: PR Conventions
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check branch name
        run: |
          branch="${{ github.head_ref }}"
          types=$(echo '${{ inputs.types }}' | tr '\n' '|' | sed 's/|$//')
          exempt=$(echo '${{ inputs.exempt_branch_prefixes }}' | tr '\n' '|' | sed 's/|$//')

          if echo "$branch" | grep -qE "^($exempt)"; then
            echo "Branch '$branch' is exempt."
            exit 0
          fi

          if echo "$branch" | grep -qE "^($types)/"; then
            echo "Branch '$branch' follows convention."
            exit 0
          fi

          echo "::error::Branch '$branch' does not follow type/description convention."
          echo "Valid types: $(echo '${{ inputs.types }}' | tr '\n' ', ' | sed 's/, $//')"
          echo "Examples: feat/export-csv, fix/nil-panic, ci/add-govulncheck"
          exit 1

      - name: Check commit messages
        if: success() || failure()
        run: |
          types=$(echo '${{ inputs.types }}' | tr '\n' '|' | sed 's/|$//')
          pattern="^($types)(\(.+\))?: .+"
          failed=false

          for sha in $(git rev-list "origin/${{ github.base_ref }}..HEAD"); do
            subject=$(git log --format=%s -n1 "$sha")
            if echo "$subject" | grep -qE "^Merge"; then
              continue
            fi
            if ! echo "$subject" | grep -qE "$pattern"; then
              echo "::error::Invalid commit message: $subject (commit: ${sha:0:7})"
              echo "  Expected: type: description  or  type(scope): description"
              failed=true
            fi
          done

          if [ "$failed" = true ]; then
            echo ""
            echo "Valid types: $(echo '${{ inputs.types }}' | tr '\n' ', ' | sed 's/, $//')"
            exit 1
          fi
          echo "All commit messages follow Conventional Commits format."

      - name: Check commits are verified
        if: success() || failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          failed=false
          commits=$(gh api --paginate "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits")

          for row in $(echo "$commits" | jq -r '.[] | @base64'); do
            sha=$(echo "$row" | base64 -d | jq -r '.sha[:7]')
            verified=$(echo "$row" | base64 -d | jq -r '.commit.verification.verified')
            subject=$(echo "$row" | base64 -d | jq -r '.commit.message | split("\n")[0]')

            if [ "$verified" != "true" ]; then
              echo "::error::Unverified commit: $sha $subject"
              failed=true
            fi
          done

          if [ "$failed" = true ]; then
            echo ""
            echo "All commits must be signed."
            echo "See: https://docs.github.com/en/authentication/managing-commit-signature-verification"
            exit 1
          fi
          echo "All commits are verified."
